<!-- Se incluye el layout del header -->
<%- include('layouts/header') %>
<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Reportes</h2>
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="/sistema">Home</a>
            </li>
            <li class="breadcrumb-item">
                <a>Reportes</a>
            </li>
            <li class="breadcrumb-item active">
                <strong>Siniestralidad</strong>
            </li>
        </ol>
    </div>
</div>
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>Consulta de Siniestralidad Póliza</h5>
                </div>
                <div class="ibox-content">
                    <form method="POST" action="/sistema/accident-rate">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="ibox">
                                    <div class="form-control">
                                        <div class="form-group row"><label class="col-sm-3 col-form-label">Fecha Desde</label>
                                            <div class="col-sm-9">
                                                <input 
                                                    type="date"
                                                    name="fecha_desde"
                                                    id="fecha_desde"
                                                    class="form-control"
                                                >
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>
                                        <div class="form-group row"><label class="col-sm-3 col-form-label">Fecha Hasta</label>
                                            <div class="col-sm-9">
                                                <input 
                                                    type="date"
                                                    name="fecha_hasta"
                                                    id="fecha_hasta"
                                                    class="form-control"
                                                >
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>
                                        <div class="form-group row"><label class="col-sm-3 col-form-label">Aseguradora</label>
                                            <div class="col-sm-9">
                                                <select class="form-control" name="nombre_aseguradora">
                                                    <option value="">Seleccione</option>
                                                    <% insurers.forEach((insurer) => { %>
                                                        <option value="<%= insurer.nombre_aseguradora %>"><%= insurer.nombre_aseguradora %></option>
                                                    <% }); %>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>
                                        <div class="form-group row"><label class="col-sm-3 col-form-label">Póliza</label>
                                            <div class="col-sm-9">
                                                <select class="form-control" name="numero_poliza" onmousedown="if(this.options.length>2)this.size=2" onchange="this.size=0" onblur="this.size=0">
                                                    <option value="">Seleccione</option>
                                                    <% policies.forEach((policy) => { %>
                                                        <option value="<%= policy.numero_poliza %>"><%= policy.numero_poliza %></option>
                                                    <% }); %>
                                                    <% collectives.forEach((collective) => { %>
                                                        <option value="<%= collective.numero_colectivo %>"><%= collective.numero_colectivo %></option>
                                                    <% }); %>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="ibox">
                                    <div class="form-control">
                                        <div class="form-group row"><label class="col-sm-3 col-form-label">Ramo</label>
                                            <div class="col-sm-9">
                                                <select class="form-control" name="ramo_poliza">
                                                    <option value="">Seleccione</option>
                                                    <option value="SALUD INDIVIDUAL">SALUD INDIVIDUAL</option>
                                                    <option value="AUTOMÓVIL INDIVIDUAL">AUTOMÓVIL INDIVIDUAL</option>
                                                    <option value="PATRIMONIAL INDIVIDUAL">PATRIMONIAL INDIVIDUAL</option>
                                                    <option value="FIANZA INDIVIDUAL">FIANZA INDIVIDUAL</option>
                                                    <option value="OTROS RAMOS INDIVIDUAL">OTROS RAMOS INDIVIDUAL</option>
                                                    <option value="FUNERARIO INDIVIDUAL">FUNERARIO INDIVIDUAL</option>
                                                    <option value="VIDA INDIVIDUAL">VIDA INDIVIDUAL</option>
                                                    <option value="AP INDIVIDUAL">AP INDIVIDUAL</option>
                                                    <option value="VIAJE INDIVIDUAL">VIAJE INDIVIDUAL</option>
                                                    <option value="SALUD COLECTIVO">SALUD COLECTIVO</option>
                                                    <option value="AUTOMÓVIL COLECTIVO">AUTOMÓVIL COLECTIVO</option>
                                                    <option value="RIESGOS DIVERSOS COLECTIVO">RIESGOS DIVERSOS COLECTIVO</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>
                                        <div class="form-group row"><label class="col-sm-3 col-form-label">Agente Propio</label>
                                            <div class="col-sm-9">
                                                <select class="form-control" name="nombre_agente_propio">
                                                    <option value="">Seleccione</option>
                                                    <% ownAgents.forEach((ownAgent) => { %>
                                                        <option value="<%= ownAgent.nombre_agente_propio %> <%= ownAgent.apellido_agente_propio %>"><%= ownAgent.nombre_agente_propio %> <%= ownAgent.apellido_agente_propio %></option>
                                                    <% }); %>
                                                    <option value="ATINA">ATINA</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>
                                        <div class="form-group row"><label class="col-sm-3 col-form-label">Cliente</label>
                                            <div class="col-sm-9 field">
                                                <div class="numeral-selector selector">
                                                    <div class="select-box-wrapper">
                                                        <select name="tipo_id_rif_asegurado" id="select_box">
                                                            <option value="V">V</option>
                                                            <option value="E">E</option>
                                                            <option value="J">J</option>
                                                            <option value="G">G</option>
                                                            <option value="I">I</option>
                                                            <option value="F">F</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <input 
                                                    type="text"
                                                    name="id_rif_asegurado"
                                                    id="id_rif_asegurado"
                                                    placeholder="Cliente Cédula/Rif" 
                                                    class="form-control input-numeral"
                                                >
                                            </div>
                                        </div>
                                        <div class="hr-line-dashed"></div>
                                        <div class="form-group row"><label class="col-sm-3 col-form-label">Tipo</label>
                                            <div class="col-sm-9">
                                                <select class="form-control" name="tipo_siniestro">
                                                    <option value="">Seleccione</option>
                                                    <option value="REEMBOLSO">REEMBOLSO</option>
                                                    <option value="CARTA AVAL">CARTA AVAL</option>
                                                    <option value="EMERGENCIA">EMERGENCIA</option>
                                                    <option value="AMP">AMP</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="form-group row">
                            <div class="col-sm-12 col-sm-offset-2">
                                <div class="card-body d-flex">
                                    <button class="btn btn-primary btn-sm ml-auto" type="submit">Consultar</button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <% if (typeof(data) !== 'undefined') { %>
                        <div class="table-responsive">
                            <table 
                                class="table table-striped table-bordered table-hover"
                                id="tablaSiniestros"
                            >
                            <thead>
                            <tr>
                                <th>Aseguradora</th>
                                <th>N° Póliza</th>
                                <th>N° Siniestro</th>
                                <th>CI Tomador</th>
                                <th>Tomador</th>
                                <th>CI Beneficiario</th>
                                <th>Beneficiario</th>
                                <th>Patología</th>
                                <th>Tipo de Siniestro</th>
                                <th>Monto</th>
                                <th>Estatus</th>
                            </tr>
                            </thead>
                            <tbody>
                                
                            </tbody>
                            <tfoot>
                            <tr>
                                <th>Aseguradora</th>
                                <th>N° Póliza</th>
                                <th>N° Siniestro</th>
                                <th>CI Tomador</th>
                                <th>Tomador</th>
                                <th>CI Beneficiario</th>
                                <th>Beneficiario</th>
                                <th>Patología</th>
                                <th>Tipo de Siniestro</th>
                                <th>Monto</th>
                                <th>Estatus</th>
                            </tr>
                            </tfoot>
                            </table>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>
</br>
</br>
</br>
<div class="footer">
    
</div>
</div>
</div>

<!-- Mainly scripts -->
<script src="/js/jquery-3.1.1.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

<!-- Flot -->
<script src="/js/plugins/flot/jquery.flot.js"></script>
<script src="/js/plugins/flot/jquery.flot.tooltip.min.js"></script>
<script src="/js/plugins/flot/jquery.flot.spline.js"></script>
<script src="/js/plugins/flot/jquery.flot.resize.js"></script>
<script src="/js/plugins/flot/jquery.flot.pie.js"></script>

<!-- Peity -->
<script src="/js/plugins/peity/jquery.peity.min.js"></script>
<script src="/js/demo/peity-demo.js"></script>

<!-- Custom and plugin javascript -->
<script src="/js/inspinia.js"></script>
<script src="/js/plugins/pace/pace.min.js"></script>

<!-- jQuery UI -->
<script src="/js/plugins/jquery-ui/jquery-ui.min.js"></script>

<!-- GITTER -->
<script src="/js/plugins/gritter/jquery.gritter.min.js"></script>

<!-- Sparkline -->
<script src="/js/plugins/sparkline/jquery.sparkline.min.js"></script>

<!-- Sparkline demo data  -->
<script src="/js/demo/sparkline-demo.js"></script>

<!-- ChartJS-->
<script src="/js/plugins/chartJs/Chart.min.js"></script>

<!-- Toastr -->
<script src="/js/plugins/toastr/toastr.min.js"></script>

<!-- DataTables -->
<script src="/js/plugins/dataTables/datatables.min.js"></script>
<script src="/js/plugins/dataTables/dataTables.bootstrap4.min.js"></script>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="/js/cleave-js/cleave.min.js"></script>

<!-- Page-Level Scripts -->

<% if (typeof(data) !== 'undefined') { %>
    <script>
        function toDataURL(src, callback){
            var image = new Image();
            image.crossOrigin = 'Anonymous';
            image.onload = function(){
                var canvas = document.createElement('canvas');
                var context = canvas.getContext('2d');
                canvas.height = this.naturalHeight;
                canvas.width = this.naturalWidth;
                context.drawImage(this, 0, 0);
                var dataURL = canvas.toDataURL('image/png');
                callback(dataURL);
            };
            image.src = src;
        }   
        toDataURL('/img/LOGOTIPO_VPRINCIPAL_ATINA.png', function(dataURL){
            localStorage.setItem("formDataImageAtina", dataURL) 
        });
    </script>
    
    <script>
        var lista = <%- JSON.stringify(data) %>;
        var tablaSiniestro = null;
        $(document).ready(function(){
            tablaSiniestro = $('#tablaSiniestros').DataTable({
                pageLength: 25,
                responsive: true,
                dom: '<"html5buttons"B>lTfgitp',
                processing: true,
                serverSide: false,
                order: [[0, 'desc']],
                columns: [
                    {"data": "nombre_aseguradora"},
                    {"data": "numero_poliza"},
                    {"data": "numero_siniestro"},
                    {"data": "ci_tomador_poliza"},
                    {"data": "nombre_tomador_poliza"},
                    {"data": "cedula_beneficiario"},
                    {"data": "nombre_completo_beneficiario"},
                    {"data": "patologia_siniestro"},
                    {"data": "tipo_siniestro"},
                    {"data": "monto_siniestro"},
                    {"data": "estatus_siniestro"},
                ],
                buttons: [
                    {extend: 'excel', title: 'Siniestralidad'},
                    {
                        extend: 'pdfHtml5',
                        title: 'Siniestralidad',
                        customize: function ( doc ) {
                            doc.content.splice( 1, 0, {
                                margin: [ 0, 0, 0, 12 ],
                                alignment: 'left',
                                image: localStorage.formDataImageAtina,
                                width: 80,
                                height: 30
                            } );
                        }
                    },
                    {
                        extend: 'print',
                        customize: function (win){
                            $(win.document.body).addClass('white-bg');
                            $(win.document.body).css('font-size', '10px');

                            $(win.document.body).find('table')
                                    .addClass('compact')
                                    .css('font-size', 'inherit');
                        },
                        text: 'Imprimir'
                    }
                ],
                language: {
                    "decimal": "",
                    "emptyTable": "No hay información",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Entradas",
                    "infoEmpty": "Mostrando 0 to 0 of 0 Entradas",
                    "infoFiltered": "(Filtrado de _MAX_ total entradas)",
                    "infoPostFix": "",
                    "thousands": ".",
                    "lengthMenu": "Mostrar _MENU_ Entradas",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscar:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                }
            });
            tablaSiniestro.rows.add(lista);
            tablaSiniestro.draw();
        });
    </script>
<% } %>

<script>
    if (($('#select_box').val() === 'V') || ($('#select_box').val() === 'E')) {
        var cleaveNumeral = new Cleave('.input-numeral', {
            numeral: true,
            numeralDecimalMark: ',',
            delimiter: '.',
            stripLeadingZeroes: false
        });
    } else {
        var cleaveNumeral = new Cleave('.input-numeral', {
            numeral: true,
            numeralDecimalMark: '!',
            delimiter: '',
            stripLeadingZeroes: false
        });
    }

    $('#select_box').change(function(){
        if ((this.value === 'V') || (this.value === 'E')) {
            var cleaveNumeral = new Cleave('.input-numeral', {
                numeral: true,
                numeralDecimalMark: ',',
                delimiter: '.',
                stripLeadingZeroes: false
            });
            cleaveNumeral.setRawValue('');
        } else {
            var cleaveNumeral = new Cleave('.input-numeral', {
                numeral: true,
                numeralDecimalMark: '!',
                delimiter: '',
                stripLeadingZeroes: false,
            });
            cleaveNumeral.setRawValue('');
        }
    });
</script>

</body>

</html>